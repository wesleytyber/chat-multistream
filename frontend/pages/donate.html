<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Donate</title>
    <link rel="stylesheet" href="../assets/css/donate.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&family=Orbitron:wght@500;700&display=swap"
        rel="stylesheet">
</head>

<body>

    <header>Kalzan</header>

    <!-- Página de Doação -->
    <main class="donation-page">
        <div class="left">
            <h2>Obrigado pelo seu apoio!</h2>
            <p>Muito obrigado pelo seu apoio. Deixe uma mensagem junto com sua doação!</p>
        </div>
        <div class="right">
            <input type="text" id="donorName" placeholder="Seu nome">
            <textarea id="donorMessage" placeholder="Escreva uma mensagem (opcional)"></textarea>
            <div class="donate-options">
                <button class="amount-btn" data-amount="5">R$5</button>
                <button class="amount-btn" data-amount="10">R$10</button>
                <button class="amount-btn" data-amount="20">R$20</button>
                <input type="number" id="customAmount" placeholder="Outro valor">
            </div>
            <button id="donateBtn">Doar & Enviar mensagem</button>
        </div>
    </main>

    <!-- Página de Checkout -->
    <main class="checkout hidden">
        <div class="left">
            <h2>Detalhes de pagamentos</h2>
            <button id="backToDonation">← Voltar</button>
            <div class="donate-options">
                <button class="amount-btn" data-amount="5">R$5</button>
                <button class="amount-btn" data-amount="10">R$10</button>
                <button class="amount-btn" data-amount="20">R$20</button>
                <input type="number" id="customAmountCheckout" placeholder="Outro valor">
            </div>
            <div id="paypal-button-container"></div>
        </div>
        <div class="right">
            <div class="subtotal">Subtotal: R$ <span id="subtotal">0.00</span></div>
            <div class="total">Total (BRL): R$ <span id="total">0.00</span></div>
        </div>
    </main>

    <script
        src="https://www.paypal.com/sdk/js?client-id=ARxK-k7eIDOz0mkknhQRH-nWTDmY3kTVuD-Kp_kkVb-BN2Kz_fDadxXy81b-6YMBI3sEcnXM2pnmZfgI&currency=BRL"></script>
    <script>
        let selectedAmount = null;

        // Botão de voltar
        document.getElementById("backToDonation").addEventListener("click", () => {
            document.querySelector(".checkout").style.display = "none";
            document.querySelector(".donation-page").style.display = "grid";

            // Limpa valores do checkout
            document.getElementById("customAmountCheckout").value = "";
            updateCheckoutValues("0.00");
        });

        // Função para atualizar subtotal/total
        function updateCheckoutValues(valor) {
            document.getElementById("subtotal").textContent = valor;
            document.getElementById("total").textContent = valor;
        }

        // Seleção do valor na donation page
        document.querySelectorAll(".donation-page .amount-btn").forEach(btn => {
            btn.addEventListener("click", () => {
                selectedAmount = btn.dataset.amount;
                document.querySelectorAll(".donation-page .amount-btn").forEach(b => b.classList.remove("active"));
                btn.classList.add("active");
                document.getElementById("customAmount").value = "";
            });
        });

        document.getElementById("customAmount").addEventListener("input", e => {
            let val = e.target.value.trim();
            if (val !== "") selectedAmount = null;
            document.querySelectorAll(".donation-page .amount-btn").forEach(b => b.classList.remove("active"));
        });

        // Clique no botão Doar & Enviar mensagem
        document.getElementById("donateBtn").addEventListener("click", () => {
            const donationCustom = document.getElementById("customAmount").value.trim();
            let valor = donationCustom !== "" ? donationCustom : (selectedAmount || "5");

            // Atualiza subtotal/total
            updateCheckoutValues(valor);

            // Mostra checkout e esconde donation page
            document.querySelector(".donation-page").style.display = "none";
            document.querySelector(".checkout").style.display = "grid";

            // Referências
            const checkoutButtons = document.querySelectorAll(".checkout .amount-btn");
            const checkoutCustom = document.getElementById("customAmountCheckout");
            const paypalContainer = document.getElementById("paypal-button-container");

            paypalContainer.innerHTML = ""; // limpa botão antigo

            // Função para selecionar valor no checkout
            function selectCheckoutAmount(amount, isCustom = false) {
                checkoutButtons.forEach(b => b.classList.remove("active"));
                if (!isCustom) {
                    checkoutButtons.forEach(b => {
                        if (b.dataset.amount === amount) b.classList.add("active");
                    });
                    checkoutCustom.value = "";
                } else {
                    checkoutCustom.value = amount;
                }
                updateCheckoutValues(amount);
                return amount;
            }

            // Preenche valor do donation page no checkout
            if (donationCustom !== "") {
                selectCheckoutAmount(donationCustom, true);
            } else {
                selectCheckoutAmount(valor);
            }

            // Evita adicionar múltiplos listeners
            checkoutButtons.forEach(btn => {
                btn.onclick = () => {
                    selectedAmount = selectCheckoutAmount(btn.dataset.amount);
                };
            });

            checkoutCustom.oninput = e => {
                let val = e.target.value.trim();
                if (val !== "") {
                    selectedAmount = null;
                    checkoutButtons.forEach(b => b.classList.remove("active"));
                    updateCheckoutValues(val);
                }
            };

            // Inicializa PayPal
            paypal.Buttons({
                createOrder: (data, actions) => {
                    const finalValue = checkoutCustom.value.trim() !== "" ? checkoutCustom.value.trim() : (selectedAmount || "5");
                    return actions.order.create({
                        purchase_units: [{ amount: { value: finalValue } }]
                    });
                },
                onApprove: (data, actions) => {
                    return actions.order.capture().then(details => {
                        const finalValue = checkoutCustom.value.trim() !== "" ? checkoutCustom.value.trim() : (selectedAmount || "5");
                        alert(`Obrigado ${details.payer.name.given_name}! Doação de R$${finalValue} concluída ✅`);
                    });
                }
            }).render('#paypal-button-container');
        });

    </script>
</body>

</html>